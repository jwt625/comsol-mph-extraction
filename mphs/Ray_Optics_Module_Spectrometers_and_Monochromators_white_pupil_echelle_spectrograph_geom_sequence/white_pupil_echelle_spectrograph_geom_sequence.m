function out = model
%
% white_pupil_echelle_spectrograph_geom_sequence.m
%
% Model exported on May 26 2025, 21:32 by COMSOL 6.2.0.339.

import com.comsol.model.*
import com.comsol.model.util.*

model = ModelUtil.create('Model');

model.modelPath('/Applications/COMSOL62/Multiphysics/applications/Ray_Optics_Module/Spectrometers_and_Monochromators');

model.modelNode.create('comp1', true);

model.geom.create('geom1', 3);
model.geom('geom1').model('comp1');

model.mesh.create('mesh1', 'geom1');

% To import content from file, use:
% model.param.loadFile('FILENAME');
model.param.set('B', '100.0[mm]', 'Collimated beam diameter');
model.param.set('d_mag', '2.0', 'White pupil demagnification constant (i.e, f_1/f_2)');
model.param.set('f_1', '800[mm]', 'Primary mirror (OAP 1) focal length');
model.param.set('f_2', 'f_1/d_mag', 'Secondary mirror (OAP 2) focal length');
model.param.set('f_clear', '0.95', 'Mirror clear aperture fraction');
model.param.set('d0_OAP_1', '185.0[mm]', 'Full diameter of OAP 1');
model.param.set('dc_OAP_1', 'f_clear*d0_OAP_1', 'Clear diameter of OAP 1');
model.param.set('Tc_OAP_1', 'd0_OAP_1/6', 'Center thickness OAP 1');
model.param.set('d0_OAP_2', '125.0[mm]', 'Full diameter of OAP 2');
model.param.set('dc_OAP_2', 'f_clear*d0_OAP_2', 'Clear diameter of OAP 2');
model.param.set('Tc_OAP_2', 'd0_OAP_2/6', 'Center thickness OAP 2');
model.param.set('theta_i', '7.50[deg]', 'OAP off axis angle');
model.param.set('dx_1', 'f_1*tan(theta_i)', 'Entrance pupil off axis distance');
model.param.set('dx_2', 'f_2*tan(theta_i)', 'Exit pupil off axis distance');
model.param.set('dx_1_nom', 'dx_1-f_1*tan(2*gamma_ech)', 'Primary mirror off axis distance');
model.param.set('dx_2_nom', 'dx_2+f_1*tan(2*gamma_ech)', 'Secondary mirror off axis distance');
model.param.set('R_num', '4.0', 'Echelle grating R#');
model.param.set('theta_B', 'atan(R_num)', 'Echelle grating blaze angle');
model.param.set('gamma_ech', '-0.65[deg]', 'Echelle grating out of plane angle');
model.param.set('W_ech', '1.05*B', 'Echelle grating width');
model.param.set('D_ech', 'R_num*W_ech', 'Echelle grating depth');
model.param.set('H_ech', 'D_ech/10', 'Echelle grating height');
model.param.set('lam_xdp', '525.0[nm]', 'Cross-disp. grating mid-wavelength');
model.param.set('T_xdp', '725.0[mm^-1]', 'Cross-disp. grating line frequency');
model.param.set('sigma_xdp', '1/T_xdp', 'Cross-disp. grating line spacing');
model.param.set('theta_xdp', 'asin(lam_xdp/(2*sigma_xdp))', 'Cross-disp. grating blaze angle');
model.param.set('W_xdp', '1.50*B/d_mag', 'Cross-disp. grating width');
model.param.set('D_xdp', '1.25*B/d_mag', 'Cross-disp. grating depth');
model.param.set('H_xdp', 'W_xdp/10', 'Cross-disp. grating height');
model.param.set('Z_xdp', '-75.0[mm]', '                            Cross-disp. grating displacement');

model.view('view1').camera.set('projection', 'orthographic');

model.geom.load({'part1'}, 'Ray_Optics_Module/3D/Mirrors/conic_mirror_off_axis_3d.mph', {'part1'});
model.geom.create('part2', 'Part', 3);
model.geom('part2').label('Grating');
model.geom('part2').inputParam.set('W', '50[mm]');
model.geom('part2').inputParam.descr('W', 'Grating Width');
model.geom('part2').inputParam.set('D', '75[mm]');
model.geom('part2').inputParam.descr('D', 'Grating Depth');
model.geom('part2').inputParam.set('H', '10[mm]');
model.geom('part2').inputParam.descr('H', 'Grating Height');
model.geom('part2').create('blk1', 'Block');
model.geom('part2').feature('blk1').set('size', {'W' 'D' 'H'});
model.geom('part2').feature('blk1').set('base', 'center');
model.geom('part2').feature('blk1').set('pos', {'0' '0' '-H/2'});
model.geom('part2').run('blk1');
model.geom('part2').create('sel1', 'ExplicitSelection');
model.geom('part2').feature('sel1').label('All');
model.geom('part2').feature('sel1').selection('selection').set('blk1', 1);
model.geom('part2').run('sel1');
model.geom('part2').create('sel2', 'ExplicitSelection');
model.geom('part2').feature('sel2').label('Exterior');
model.geom('part2').feature('sel2').selection('selection').init(2);
model.geom('part2').feature('sel2').selection('selection').set('blk1', [1 2 3 4 5 6]);
model.geom('part2').run('sel2');
model.geom('part2').create('sel3', 'ExplicitSelection');
model.geom('part2').feature('sel3').label('Grating Surface');
model.geom('part2').feature('sel3').selection('selection').init(2);
model.geom('part2').feature('sel3').selection('selection').set('blk1', 4);
model.geom('part2').run('sel3');
model.geom('part2').create('difsel1', 'DifferenceSelection');
model.geom('part2').feature('difsel1').label('Grating Obstruction');
model.geom('part2').feature('difsel1').set('entitydim', 2);
model.geom('part2').feature('difsel1').set('add', {'sel2'});
model.geom('part2').feature('difsel1').set('subtract', {'sel3'});
model.geom('geom1').label(['White Pupil ' native2unicode(hex2dec({'00' 'c9'}), 'unicode') 'chelle Geometry Sequence']);
model.geom('geom1').lengthUnit('mm');
model.geom('geom1').create('pt1', 'Point');
model.geom('geom1').feature('pt1').label('Entrance Point');
model.geom('geom1').feature('pt1').set('selresult', true);
model.geom('geom1').run('pt1');
model.geom('geom1').create('wp1', 'WorkPlane');
model.geom('geom1').feature('wp1').set('unite', true);
model.geom('geom1').feature('wp1').label(['Pre Gamma ' native2unicode(hex2dec({'00' 'c9'}), 'unicode') 'chelle Facet Tangent Plane']);
model.geom('geom1').feature('wp1').set('planetype', 'transformed');
model.geom('geom1').feature('wp1').set('transdispl', {'dx_1' '0' '0'});
model.geom('geom1').feature('wp1').set('transaxistype', 'x');
model.geom('geom1').feature('wp1').set('transrot', '90[deg]');
model.geom('geom1').run('wp1');
model.geom('geom1').create('wp2', 'WorkPlane');
model.geom('geom1').feature('wp2').set('unite', true);
model.geom('geom1').feature('wp2').label(['Post Gamma ' native2unicode(hex2dec({'00' 'c9'}), 'unicode') 'chelle Facet Tangent Plane']);
model.geom('geom1').feature('wp2').set('planetype', 'transformed');
model.geom('geom1').feature('wp2').set('workplane', 'wp1');
model.geom('geom1').feature('wp2').set('transrot', 'gamma_ech');
model.geom('geom1').run('wp2');
model.geom('geom1').create('wp3', 'WorkPlane');
model.geom('geom1').feature('wp3').set('unite', true);
model.geom('geom1').feature('wp3').label([native2unicode(hex2dec({'00' 'c9'}), 'unicode') 'chelle Grating Normal Plane']);
model.geom('geom1').feature('wp3').set('planetype', 'transformed');
model.geom('geom1').feature('wp3').set('workplane', 'wp2');
model.geom('geom1').feature('wp3').set('transaxistype', 'x');
model.geom('geom1').feature('wp3').set('transrot', 'theta_B-90');
model.geom('geom1').run('wp3');
model.geom('geom1').create('wp4', 'WorkPlane');
model.geom('geom1').feature('wp4').set('unite', true);
model.geom('geom1').feature('wp4').label('White Pupil Plane');
model.geom('geom1').feature('wp4').set('planetype', 'transformed');
model.geom('geom1').feature('wp4').set('transdispl', {'-dx_2' '0' '0'});
model.geom('geom1').feature('wp4').set('transaxistype', 'y');
model.geom('geom1').feature('wp4').set('transrot', '4*gamma_ech');
model.geom('geom1').run('wp4');
model.geom('geom1').create('wp5', 'WorkPlane');
model.geom('geom1').feature('wp5').set('unite', true);
model.geom('geom1').feature('wp5').label('Cross Dispersion Plane');
model.geom('geom1').feature('wp5').set('planetype', 'transformed');
model.geom('geom1').feature('wp5').set('workplane', 'wp4');
model.geom('geom1').feature('wp5').set('transdispl', {'0' '0' 'Z_xdp'});
model.geom('geom1').feature('wp5').set('transaxistype', 'y');
model.geom('geom1').feature('wp5').set('transrot', '-theta_xdp');
model.geom('geom1').run('wp5');
model.geom('geom1').create('wp6', 'WorkPlane');
model.geom('geom1').feature('wp6').set('unite', true);
model.geom('geom1').feature('wp6').label('Camera Plane');
model.geom('geom1').feature('wp6').set('planetype', 'transformed');
model.geom('geom1').feature('wp6').set('workplane', 'wp5');
model.geom('geom1').feature('wp6').set('transaxistype', 'y');
model.geom('geom1').feature('wp6').set('transrot', '-theta_xdp');
model.geom('geom1').run('wp6');
model.geom('geom1').create('pi1', 'PartInstance');
model.geom('geom1').feature('pi1').set('selkeepnoncontr', false);
model.geom('geom1').feature('pi1').set('part', 'part1');
model.geom('geom1').feature('pi1').label('Primary Mirror');
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'R', '-2*f_1');
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'k', -1);
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'Tc', 'Tc_OAP_1');
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'd0', 'd0_OAP_1');
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'd_clear', 'dc_OAP_1');
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'dx', 'dx_1_nom');
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'nix', 0);
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'niy', 0);
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'niz', 1);
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'nxx', 1);
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'nxy', 0);
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'nxz', 0);
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'mtype', 1);
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'show_vertex', 0);
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'n_extra_r', 0);
model.geom('geom1').feature('pi1').setEntry('inputexpr', 'n_extra_a', 0);
model.geom('geom1').feature('pi1').set('displ', {'0' '0' 'f_1'});
model.geom('geom1').run('pi1');
model.geom('geom1').create('pi2', 'PartInstance');
model.geom('geom1').feature('pi2').set('selkeepnoncontr', false);
model.geom('geom1').feature('pi2').set('part', 'part1');
model.geom('geom1').feature('pi2').label('Secondary Mirror');
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'R', '-2*f_2');
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'k', -1);
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'Tc', 'Tc_OAP_2');
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'd0', 'd0_OAP_2');
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'd_clear', 'dc_OAP_2');
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'dx', 'dx_2_nom');
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'nix', 0);
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'niy', 0);
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'niz', -1);
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'nxx', -1);
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'nxy', 0);
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'nxz', 0);
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'mtype', 0);
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'show_vertex', 0);
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'n_extra_r', 0);
model.geom('geom1').feature('pi2').setEntry('inputexpr', 'n_extra_a', 0);
model.geom('geom1').feature('pi2').set('displ', {'0' '0' '-f_2'});
model.geom('geom1').run('pi2');
model.geom('geom1').create('pi3', 'PartInstance');
model.geom('geom1').feature('pi3').set('selkeepnoncontr', false);
model.geom('geom1').feature('pi3').set('part', 'part2');
model.geom('geom1').feature('pi3').label([native2unicode(hex2dec({'00' 'c9'}), 'unicode') 'chelle Grating']);
model.geom('geom1').feature('pi3').set('workplane', 'wp3');
model.geom('geom1').feature('pi3').setEntry('inputexpr', 'W', 'W_ech');
model.geom('geom1').feature('pi3').setEntry('inputexpr', 'D', 'D_ech');
model.geom('geom1').feature('pi3').setEntry('inputexpr', 'H', 'H_ech');
model.geom('geom1').run('pi3');
model.geom('geom1').create('pi4', 'PartInstance');
model.geom('geom1').feature('pi4').set('selkeepnoncontr', false);
model.geom('geom1').feature('pi4').set('part', 'part2');
model.geom('geom1').feature('pi4').label('Cross Dispersion Grating Entrance');
model.geom('geom1').feature('pi4').setEntry('inputexpr', 'W', 'W_xdp');
model.geom('geom1').feature('pi4').setEntry('inputexpr', 'D', 'D_xdp');
model.geom('geom1').feature('pi4').setEntry('inputexpr', 'H', 'H_xdp');
model.geom('geom1').feature('pi4').set('workplane', 'wp5');
model.geom('geom1').feature('pi4').set('rot', 90);
model.geom('geom1').run('pi4');
model.geom('geom1').create('pi5', 'PartInstance');
model.geom('geom1').feature('pi5').set('selkeepnoncontr', false);
model.geom('geom1').feature('pi5').set('part', 'part2');
model.geom('geom1').feature('pi5').label('Cross Dispersion Grating Exit');
model.geom('geom1').feature('pi5').setEntry('inputexpr', 'W', 'W_xdp');
model.geom('geom1').feature('pi5').setEntry('inputexpr', 'D', 'D_xdp');
model.geom('geom1').feature('pi5').setEntry('inputexpr', 'H', 'H_xdp');
model.geom('geom1').feature('pi5').set('workplanesrc', 'pi4');
model.geom('geom1').feature('pi5').set('axistype', 'y');
model.geom('geom1').feature('pi5').set('rot', 180);
model.geom('geom1').insertFile('white_pupil_echelle_spectrograph_petzval_lens_geom_sequence.mph', 'geom1');
model.geom('geom1').feature('pi6').set('workplane', 'wp6');
model.geom('geom1').feature('pi6').set('displ', {'0' '0' '30[mm]'});
model.geom('geom1').run('pi15');
model.geom('geom1').create('sca1', 'Scale');
model.geom('geom1').feature('sca1').selection('input').set({'pi10' 'pi11' 'pi12' 'pi13' 'pi14' 'pi15' 'pi6' 'pi7' 'pi8' 'pi9'});
model.geom('geom1').feature('sca1').set('isotropic', '1.50');
model.geom('geom1').feature('sca1').set('workplanesrc', 'pi6');

model.param.set('d1_S', '37.5[mm]');
model.param.descr('d1_S', 'Stop clear diameter (adjusted)');
model.param.set('T_5', '46.819[mm]');
model.param.descr('T_5', 'L4 to L5 spacing (adjusted)');
model.param.set('R1_6', '-51.791[mm]');
model.param.descr('R1_6', 'L5, surface 1 radius of curvature (adjusted)');
model.param.set('T_6', '1.900[mm]');
model.param.descr('T_6', 'L5 to detector spacing (adjusted)');

model.geom('geom1').feature('pi8').setEntry('selcontributetobnd', 'pi8_sel1', 'csel7');
model.geom('geom1').feature('pi12').setEntry('inputexpr', 'w0', '20[mm]');
model.geom('geom1').feature('pi12').setEntry('inputexpr', 'h0', '20[mm]');
model.geom('geom1').feature('pi12').setEntry('selkeepbnd', 'pi12_sel1', true);
model.geom('geom1').feature('pi12').setEntry('selcontributetobnd', 'pi12_sel1', 'none');
model.geom('geom1').run('fin');
model.geom('geom1').selection.create('csel10', 'CumulativeSelection');
model.geom('geom1').selection('csel10').label('Mirrors');
model.geom('geom1').selection.create('csel11', 'CumulativeSelection');
model.geom('geom1').selection('csel11').label('Obstructions (Gratings and Mirrors)');
model.geom('geom1').selection.create('csel12', 'CumulativeSelection');
model.geom('geom1').selection('csel12').label('Grating Material');
model.geom('geom1').feature('pi1').setEntry('selcontributetobnd', 'pi1_cylsel2', 'csel10');
model.geom('geom1').feature('pi1').setEntry('selcontributetobnd', 'pi1_adjsel1', 'csel11');
model.geom('geom1').feature('pi1').setEntry('selcontributetobnd', 'pi1_cylsel3', 'csel11');
model.geom('geom1').feature('pi1').setEntry('selcontributetobnd', 'pi1_comsel2', 'csel11');
model.geom('geom1').feature('pi2').setEntry('selcontributetobnd', 'pi2_cylsel2', 'csel10');
model.geom('geom1').feature('pi2').setEntry('selcontributetobnd', 'pi2_adjsel1', 'csel11');
model.geom('geom1').feature('pi2').setEntry('selcontributetobnd', 'pi2_cylsel3', 'csel11');
model.geom('geom1').feature('pi2').setEntry('selcontributetobnd', 'pi2_comsel2', 'csel11');
model.geom('geom1').feature('pi3').setEntry('selkeepbnd', 'pi3_sel3', true);
model.geom('geom1').feature('pi3').setEntry('selcontributetobnd', 'pi3_difsel1', 'csel11');
model.geom('geom1').feature('pi4').setEntry('selcontributetodom', 'pi4_sel1', 'csel12');
model.geom('geom1').feature('pi4').setEntry('selkeepbnd', 'pi4_sel2', true);
model.geom('geom1').feature('pi4').setEntry('selkeepbnd', 'pi4_sel3', true);
model.geom('geom1').feature('pi5').setEntry('selcontributetodom', 'pi5_sel1', 'csel12');
model.geom('geom1').feature('pi5').setEntry('selkeepbnd', 'pi5_sel2', true);
model.geom('geom1').feature('pi5').setEntry('selkeepbnd', 'pi5_sel3', true);
model.geom('geom1').create('unisel1', 'UnionSelection');
model.geom('geom1').feature('unisel1').label('All Refracting');
model.geom('geom1').feature('unisel1').set('input', {'csel12' 'sel1'});

model.title([]);

model.description('');

model.label('white_pupil_echelle_spectrograph_geom_sequence.mph');

model.modelNode.label('Components');

out = model;
